#! /usr/bin/env bash
# 编译替换app.js

realpath() {
    [[ $1 = /* ]] && echo "$1" || echo "$PWD/${1#./}"
}

# PATHS
PROJECT_PATH=$(dirname $(dirname $(dirname $(realpath $0))))
SRC_PATH=${PROJECT_PATH}/statics/js
NOW=$(date "+%Y%m%d-%H%M%S")
NEW_NAME=app.min.${NOW}.js

# 压缩js
curl -X POST -s --data-urlencode "input@${SRC_PATH}/app.js" https://javascript-minifier.com/raw > ${SRC_PATH}/${NEW_NAME} && \

# 替换html
sed -i '' -e "s|x-stock/js/app.*.js\"{{ else }}|x-stock/js/${NEW_NAME}\"{{ else }}|g" ${PROJECT_PATH}/statics/html/base.html && \

# 上传cdn
qshell fput blogpostpics x-stock/js/${NEW_NAME} ${SRC_PATH}/${NEW_NAME} && \
# 刷新预取
echo "http://cdn.axiaoxin.com/x-stock/js/${NEW_NAME}" > /tmp/qiniu-prefetch-refresh-list.txt && \
qshell cdnprefetch -i /tmp/qiniu-prefetch-refresh-list.txt && \
qshell cdnrefresh -i /tmp/qiniu-prefetch-refresh-list.txt && \
echo "x-stock/js/${NEW_NAME}" > /tmp/qiniu-del-list.txt
